#!/usr/bin/env bash
# Phantom CLI - Zero-config AI network wrapper
# Main entry point with subcommand routing

set -euo pipefail

PHANTOM_VERSION="2.0.0"
PHANTOM_DIR="$HOME/.phantom"
PHANTOM_CONFIG="$PHANTOM_DIR/config"
SHADOW_HOME="$HOME/.phantom_env"

# Resolve the real location of this script (follow symlinks)
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_SOURCE" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ "$SCRIPT_SOURCE" != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
done
PHANTOM_LIB="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)/lib"

# ── Colors ──────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

log_info()    { echo -e "${CYAN}[info]${NC} $*"; }
log_success() { echo -e "${GREEN}[ok]${NC} $*"; }
log_warn()    { echo -e "${YELLOW}[warn]${NC} $*"; }
log_error()   { echo -e "${RED}[error]${NC} $*" >&2; }

# ── Source modules ──────────────────────────────────────────────────
source "$PHANTOM_LIB/config.sh"
source "$PHANTOM_LIB/tunnel.sh"
source "$PHANTOM_LIB/sandbox.sh"
source "$PHANTOM_LIB/hijack.sh"
source "$PHANTOM_LIB/doctor.sh"
source "$PHANTOM_LIB/auth.sh"

# ── Usage ───────────────────────────────────────────────────────────
phantom_usage() {
    cat <<EOF
${BOLD}Phantom CLI${NC} v${PHANTOM_VERSION} - Zero-config AI network wrapper

${BOLD}USAGE${NC}
    phantom                       Launch Claude (interactive mode)
    phantom [claude-args]         Pass arguments to Claude
    phantom <command> [options]   Run a subcommand

${BOLD}COMMANDS${NC}
    ${GREEN}setup <IP> [--key K|--password P]${NC}   One-click configure (IP + sync credentials)
    ${GREEN}auth sync [--key K|--password P]${NC}    Sync credentials from VPS
    ${GREEN}auth status${NC}                          Check credential and connection status
    ${GREEN}init${NC}                                 Interactive setup wizard (advanced)
    ${GREEN}connect${NC}                              Establish SSH SOCKS5 tunnel
    ${GREEN}disconnect${NC}                           Tear down tunnel
    ${GREEN}status${NC}                               Show connection status and config
    ${GREEN}doctor${NC}                               Full diagnostic check
    ${GREEN}<cmd> [args]${NC}                         Hijack and execute command through proxy

${BOLD}AUTH OPTIONS${NC}
    ${GREEN}--key K${NC}       API key authentication (recommended)
    ${YELLOW}--password P${NC}  SSH password authentication (legacy)

${BOLD}EXAMPLES${NC}
    phantom                                    # Start Claude interactive mode
    phantom -p "hello"                         # Single query (pass-through to Claude)
    phantom setup 1.2.3.4 --key myapikey      # One-click setup with API key (recommended)
    phantom setup 1.2.3.4 --password X        # Setup with SSH password (legacy)
    phantom auth sync --key myapikey          # Sync credentials via API key
    phantom auth sync --password X            # Sync credentials via SSH password (legacy)
    phantom auth status                        # Check credentials
    phantom doctor                             # Diagnostics

${BOLD}CONFIG${NC}
    ~/.phantom/config             # Configuration file
    ~/.phantom/tunnel.pid         # Tunnel PID file
    ~/.phantom_env/               # Shadow sandbox HOME

EOF
}

# ── Setup command (one-click) ──────────────────────────────────────
phantom_setup() {
    if [ $# -eq 0 ]; then
        log_error "VPS IP is required."
        log_info "Usage: phantom setup <VPS_IP> [--key API_KEY | --password PASSWORD]"
        return 1
    fi

    local host="$1"
    shift

    local api_key="" password=""
    while [ $# -gt 0 ]; do
        case "$1" in
            --key)
                if [ -z "${2:-}" ]; then
                    log_error "--key requires a value"
                    return 1
                fi
                api_key="$2"
                shift 2
                ;;
            --password)
                if [ -z "${2:-}" ]; then
                    log_error "--password requires a value"
                    return 1
                fi
                password="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    echo -e "${BOLD}Phantom Quick Setup${NC}"
    echo "════════════════════════════════════════════"
    echo ""

    # Step 1: Detect HTTP proxy port
    log_info "Detecting HTTP proxy on $host..."
    local http_proxy_port=""
    for port in 8080 8888 3128; do
        if nc -z -w 3 "$host" "$port" 2>/dev/null; then
            http_proxy_port="$port"
            log_success "Found HTTP proxy on port $port"
            break
        fi
    done

    if [ -z "$http_proxy_port" ]; then
        log_warn "No HTTP proxy detected on standard ports (8080, 8888, 3128)"
        http_proxy_port="8080"
        log_info "Using default port $http_proxy_port"
    fi

    # Step 2: Write config
    log_info "Writing configuration..."
    phantom_config_init
    phantom_config_set "SERVER_HOST" "$host"
    phantom_config_set "SERVER_PORT" "22"
    phantom_config_set "HTTP_PROXY_PORT" "$http_proxy_port"
    phantom_config_set "SSH_KEY" "~/.ssh/id_rsa"
    phantom_config_set "CONNECTION_MODE" "direct"
    phantom_config_set "AUTO_CONNECT" "true"
    phantom_config_set "AUTO_RECONNECT" "true"
    if [ -n "$api_key" ]; then
        phantom_config_set "API_KEY" "$api_key"
    fi
    log_success "Config saved to $PHANTOM_CONFIG"

    # Step 3: Create sandbox
    log_info "Setting up shadow sandbox..."
    phantom_sandbox_setup

    # Step 4: Sync credentials from VPS
    echo ""
    log_info "Syncing credentials from VPS..."
    local sync_args=()
    if [ -n "$api_key" ]; then
        sync_args+=(--key "$api_key")
    elif [ -n "$password" ]; then
        sync_args+=(--password "$password")
    fi
    phantom_auth_sync "${sync_args[@]}" || log_warn "Credential sync failed. You can retry: phantom auth sync --key YOUR_API_KEY"

    # Step 5: Verify proxy connection
    echo ""
    log_info "Verifying proxy connection..."
    local proxy_url="http://${host}:${http_proxy_port}"
    local proxy_ip
    proxy_ip=$(curl -s --max-time 10 --proxy "$proxy_url" https://ifconfig.me 2>/dev/null || echo "")

    if [ -n "$proxy_ip" ]; then
        log_success "Proxy working! External IP: $proxy_ip"
    else
        log_warn "Could not verify proxy. It may still work for Claude."
    fi

    # Summary
    echo ""
    echo -e "${BOLD}${CYAN}════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${GREEN}Setup complete!${NC}"
    echo -e "${BOLD}${CYAN}════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  Server:  ${CYAN}${host}:${http_proxy_port}${NC}"
    echo -e "  Sandbox: ${CYAN}${SHADOW_HOME}${NC}"
    echo ""
    echo -e "  ${BOLD}Quick start:${NC}"
    echo -e "    ${GREEN}phantom${NC}              # Launch Claude (interactive)"
    echo -e "    ${GREEN}phantom -p \"hello\"${NC}   # Single query"
    echo -e "    ${GREEN}phantom auth status${NC}  # Check credentials"
    echo -e "    ${GREEN}phantom doctor${NC}       # Full diagnostics"
    echo ""
}

# ── Auth command router ────────────────────────────────────────────
phantom_auth() {
    if [ $# -eq 0 ]; then
        phantom_auth_status
        return
    fi

    local subcmd="$1"
    shift

    case "$subcmd" in
        sync)
            phantom_auth_sync "$@"
            ;;
        status)
            phantom_auth_status "$@"
            ;;
        *)
            log_error "Unknown auth command: $subcmd"
            log_info "Usage: phantom auth [sync|status]"
            return 1
            ;;
    esac
}

# ── Init command (interactive wizard, backward compatible) ─────────
phantom_init() {
    echo -e "${BOLD}Phantom CLI Setup Wizard${NC}"
    echo "────────────────────────────────────────"
    echo ""

    # Ensure config dir exists
    phantom_config_init

    # VPS settings
    local current_host
    current_host=$(phantom_config_get "SERVER_HOST" 2>/dev/null || echo "")
    read -rp "VPS IP/hostname [${current_host:-none}]: " input_host
    local host="${input_host:-$current_host}"
    if [ -z "$host" ]; then
        log_error "VPS host is required"
        return 1
    fi

    local current_port
    current_port=$(phantom_config_get "SERVER_PORT" 2>/dev/null || echo "22")
    read -rp "SSH port [${current_port}]: " input_port
    local port="${input_port:-$current_port}"

    local current_http_proxy_port
    current_http_proxy_port=$(phantom_config_get "HTTP_PROXY_PORT" 2>/dev/null || echo "8080")
    read -rp "HTTP proxy port [${current_http_proxy_port}]: " input_http_proxy_port
    local http_proxy_port="${input_http_proxy_port:-$current_http_proxy_port}"

    # SSH key (for tunnel mode)
    local current_ssh_key
    current_ssh_key=$(phantom_config_get "SSH_KEY" 2>/dev/null || echo "$HOME/.ssh/id_rsa")
    read -rp "SSH key path [${current_ssh_key}]: " input_ssh_key
    local ssh_key="${input_ssh_key:-$current_ssh_key}"

    # Connection mode
    local current_mode
    current_mode=$(phantom_config_get "CONNECTION_MODE" 2>/dev/null || echo "direct")
    echo ""
    echo "Connection mode:"
    echo "  direct  - Connect to VPS HTTP proxy directly (simpler, recommended)"
    echo "  tunnel  - SSH tunnel to VPS (more secure, encrypts traffic)"
    read -rp "Connection mode (direct/tunnel) [${current_mode}]: " input_mode
    local connection_mode="${input_mode:-$current_mode}"

    # Save config
    phantom_config_set "SERVER_HOST" "$host"
    phantom_config_set "SERVER_PORT" "$port"
    phantom_config_set "HTTP_PROXY_PORT" "$http_proxy_port"
    phantom_config_set "SSH_KEY" "$ssh_key"
    phantom_config_set "CONNECTION_MODE" "$connection_mode"

    echo ""
    log_success "Configuration saved to $PHANTOM_CONFIG"

    # Setup sandbox
    phantom_sandbox_setup
    log_success "Shadow sandbox created at $SHADOW_HOME"

    echo ""
    log_info "Run ${GREEN}phantom${NC} to start Claude through the proxy"
}

# ── Status command ──────────────────────────────────────────────────
phantom_status() {
    echo -e "${BOLD}Phantom Status${NC}"
    echo "────────────────────────────────────────"

    # Config check
    if [ ! -f "$PHANTOM_CONFIG" ]; then
        log_warn "Not configured. Run: phantom setup <VPS_IP>"
        return 1
    fi

    local host port http_proxy_port connection_mode
    host=$(phantom_config_get "SERVER_HOST" 2>/dev/null || echo "not set")
    port=$(phantom_config_get "SERVER_PORT" 2>/dev/null || echo "not set")
    http_proxy_port=$(phantom_config_get "HTTP_PROXY_PORT" 2>/dev/null || echo "8080")
    connection_mode=$(phantom_config_get "CONNECTION_MODE" 2>/dev/null || echo "direct")

    echo -e "  Server:     ${CYAN}${host}${NC}"
    echo -e "  HTTP Proxy: ${CYAN}${host}:${http_proxy_port}${NC}"
    echo -e "  Mode:       ${CYAN}${connection_mode}${NC}"
    echo -e "  Sandbox:    ${CYAN}${SHADOW_HOME}${NC}"
    echo ""

    # Proxy reachability
    if [ "$connection_mode" = "direct" ]; then
        if nc -z -w 3 "$host" "$http_proxy_port" 2>/dev/null; then
            echo -e "  Proxy:      ${GREEN}connected${NC}"
        else
            echo -e "  Proxy:      ${RED}unreachable${NC}"
        fi
    else
        phantom_tunnel_status
    fi
}

# ── Main router ─────────────────────────────────────────────────────
main() {
    # No arguments → default to launching claude
    if [ $# -eq 0 ]; then
        phantom_hijack_exec claude
        exit 0
    fi

    local cmd="$1"

    case "$cmd" in
        # Known subcommands → route to handler
        setup)
            shift
            phantom_setup "$@"
            ;;
        auth)
            shift
            phantom_auth "$@"
            ;;
        init)
            shift
            phantom_init "$@"
            ;;
        connect)
            shift
            phantom_tunnel_connect "$@"
            ;;
        disconnect)
            shift
            phantom_tunnel_disconnect "$@"
            ;;
        status)
            shift
            phantom_status "$@"
            ;;
        doctor)
            shift
            phantom_doctor_run "$@"
            ;;
        help|--help|-h)
            phantom_usage
            ;;
        version|--version|-v)
            echo "phantom v${PHANTOM_VERSION}"
            ;;
        -*)
            # Arguments starting with - → pass through to claude
            phantom_hijack_exec claude "$@"
            ;;
        *)
            # Everything else → hijack the command
            shift
            phantom_hijack_exec "$cmd" "$@"
            ;;
    esac
}

main "$@"
