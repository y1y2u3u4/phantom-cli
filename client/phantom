#!/usr/bin/env bash
# Phantom CLI - Zero-config AI network wrapper
# Main entry point with subcommand routing

set -euo pipefail

PHANTOM_VERSION="2.0.0"
PHANTOM_DIR="$HOME/.phantom"
PHANTOM_CONFIG="$PHANTOM_DIR/config"
SHADOW_HOME="$HOME/.phantom_env"

# Resolve the real location of this script (follow symlinks)
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_SOURCE" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ "$SCRIPT_SOURCE" != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
done
PHANTOM_LIB="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)/lib"

# ── Colors ──────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

log_info()    { echo -e "${CYAN}[info]${NC} $*"; }
log_success() { echo -e "${GREEN}[ok]${NC} $*"; }
log_warn()    { echo -e "${YELLOW}[warn]${NC} $*"; }
log_error()   { echo -e "${RED}[error]${NC} $*" >&2; }

# ── Source modules ──────────────────────────────────────────────────
source "$PHANTOM_LIB/config.sh"
source "$PHANTOM_LIB/tunnel.sh"
source "$PHANTOM_LIB/sandbox.sh"
source "$PHANTOM_LIB/hijack.sh"
source "$PHANTOM_LIB/doctor.sh"
source "$PHANTOM_LIB/auth.sh"

# ── Usage ───────────────────────────────────────────────────────────
phantom_usage() {
    cat <<EOF
${BOLD}Phantom CLI${NC} v${PHANTOM_VERSION} - Zero-config AI network wrapper

${BOLD}USAGE${NC}
    phantom                       Launch Claude (interactive mode)
    phantom [claude-args]         Pass arguments to Claude
    phantom <command> [options]   Run a subcommand

${BOLD}COMMANDS${NC}
    ${GREEN}setup <IP> [--key K|--password P]${NC}   One-click configure (IP + sync credentials)
    ${GREEN}auth sync [--key K|--password P]${NC}    Sync credentials from VPS
    ${GREEN}auth status${NC}                          Check credential and connection status
    ${GREEN}config [KEY [VALUE]]${NC}                 View or modify configuration
    ${GREEN}status${NC}                               Show connection status and config
    ${GREEN}doctor${NC}                               Full diagnostic check
    ${GREEN}connect${NC}                              Establish SSH tunnel (tunnel mode)
    ${GREEN}disconnect${NC}                           Tear down tunnel
    ${GREEN}<cmd> [args]${NC}                         Hijack and execute command through proxy

${BOLD}AUTH OPTIONS${NC}
    ${GREEN}--key K${NC}       API key authentication (recommended)
    ${YELLOW}--password P${NC}  SSH password authentication (legacy)

${BOLD}EXAMPLES${NC}
    phantom                                    # Start Claude interactive mode
    phantom -p "hello"                         # Single query (pass-through to Claude)
    phantom setup 1.2.3.4 --key myapikey      # One-click setup with API key (recommended)
    phantom setup 1.2.3.4 --password X        # Setup with SSH password (legacy)
    phantom auth sync --key myapikey          # Sync credentials via API key
    phantom auth sync --password X            # Sync credentials via SSH password (legacy)
    phantom auth status                        # Check credentials
    phantom config                             # View all configuration
    phantom config API_KEY sk-phantom-xxx      # Set API key
    phantom doctor                             # Diagnostics

${BOLD}CONFIG${NC}
    ~/.phantom/config             # Configuration file
    ~/.phantom/tunnel.pid         # Tunnel PID file
    ~/.phantom_env/               # Shadow sandbox HOME

EOF
}

# ── Setup command (one-click) ──────────────────────────────────────
phantom_setup() {
    # Handle --help
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
${BOLD}phantom setup${NC} - One-click VPS configuration

${BOLD}USAGE${NC}
    phantom setup <VPS_IP> [OPTIONS]

${BOLD}OPTIONS${NC}
    ${GREEN}--key API_KEY${NC}       API key authentication (recommended)
    ${GREEN}--password PASS${NC}     SSH password authentication (legacy)
    ${GREEN}--port PORT${NC}         HTTP proxy port (default: auto-detect 8080/8888/3128)

${BOLD}EXAMPLES${NC}
    phantom setup 1.2.3.4 --key sk-phantom-xxx
    phantom setup 1.2.3.4 --port 9090 --key sk-phantom-xxx
    phantom setup 1.2.3.4 --password secretpass

EOF
        return 0
    fi

    if [ $# -eq 0 ]; then
        log_error "VPS IP is required."
        log_info "Usage: phantom setup <VPS_IP> [--key API_KEY] [--port PORT]"
        log_info "  Run ${GREEN}phantom setup --help${NC} for details."
        return 1
    fi

    local host="$1"
    shift

    local api_key="" password="" custom_port=""
    while [ $# -gt 0 ]; do
        case "$1" in
            --key)
                if [ -z "${2:-}" ]; then log_error "--key requires a value"; return 1; fi
                api_key="$2"; shift 2 ;;
            --password)
                if [ -z "${2:-}" ]; then log_error "--password requires a value"; return 1; fi
                password="$2"; shift 2 ;;
            --port)
                if [ -z "${2:-}" ]; then log_error "--port requires a value"; return 1; fi
                custom_port="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    echo -e "${BOLD}Phantom Quick Setup${NC}"
    echo "════════════════════════════════════════════"
    echo ""

    # Step 1: Determine HTTP proxy port
    local http_proxy_port=""
    if [ -n "$custom_port" ]; then
        http_proxy_port="$custom_port"
        log_info "Using specified port $http_proxy_port"
    else
        log_info "Detecting HTTP proxy on $host..."
        for port in 8080 8888 3128; do
            if nc -z -w 3 "$host" "$port" 2>/dev/null; then
                http_proxy_port="$port"
                log_success "Found HTTP proxy on port $port"
                break
            fi
        done
        if [ -z "$http_proxy_port" ]; then
            http_proxy_port="8080"
            log_warn "No HTTP proxy detected. Using default port $http_proxy_port"
        fi
    fi

    # Step 2: Write config
    log_info "Writing configuration..."
    phantom_config_init
    phantom_config_set "SERVER_HOST" "$host"
    phantom_config_set "SERVER_PORT" "22"
    phantom_config_set "HTTP_PROXY_PORT" "$http_proxy_port"
    phantom_config_set "SSH_KEY" "~/.ssh/id_rsa"
    phantom_config_set "CONNECTION_MODE" "direct"
    phantom_config_set "AUTO_CONNECT" "true"
    phantom_config_set "AUTO_RECONNECT" "true"
    if [ -n "$api_key" ]; then
        phantom_config_set "API_KEY" "$api_key"
    fi
    log_success "Config saved to $PHANTOM_CONFIG"

    # Step 3: Create sandbox
    log_info "Setting up shadow sandbox..."
    phantom_sandbox_setup

    # Step 4: Sync credentials from VPS
    echo ""
    log_info "Syncing credentials from VPS..."
    local sync_args=()
    if [ -n "$api_key" ]; then
        sync_args+=(--key "$api_key")
    elif [ -n "$password" ]; then
        sync_args+=(--password "$password")
    fi

    if ! phantom_auth_sync "${sync_args[@]}" 2>/dev/null; then
        log_warn "Credential sync incomplete — this is OK if VPS hasn't done OAuth yet."
        log_info "  You can retry anytime: ${GREEN}phantom auth sync --key YOUR_KEY${NC}"
        log_info "  Or check status:       ${GREEN}phantom auth status${NC}"
    fi

    # Step 5: Verify proxy connection
    echo ""
    log_info "Verifying proxy connection..."
    if curl -s --max-time 5 "http://${host}:${http_proxy_port}/api/health" 2>/dev/null | grep -q '"ok"'; then
        log_success "Proxy is healthy!"
    elif nc -z -w 3 "$host" "$http_proxy_port" 2>/dev/null; then
        log_success "Proxy port is reachable (health check unavailable)"
    else
        log_error "Cannot reach proxy at ${host}:${http_proxy_port}"
        log_info "  Check VPS: ssh root@${host} systemctl status phantom-http-proxy"
        log_info "  Diagnostics: ${GREEN}phantom doctor${NC}"
    fi

    # Summary
    echo ""
    echo -e "${BOLD}${CYAN}════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${GREEN}Setup complete!${NC}"
    echo -e "${BOLD}${CYAN}════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  Server:  ${CYAN}${host}:${http_proxy_port}${NC}"
    echo -e "  Sandbox: ${CYAN}${SHADOW_HOME}${NC}"
    echo ""
    echo -e "  ${BOLD}Quick start:${NC}"
    echo -e "    ${GREEN}phantom${NC}              # Launch Claude (interactive)"
    echo -e "    ${GREEN}phantom -p \"hello\"${NC}   # Single query"
    echo -e "    ${GREEN}phantom auth status${NC}  # Check credentials"
    echo -e "    ${GREEN}phantom doctor${NC}       # Full diagnostics"
    echo ""
}

# ── Auth command router ────────────────────────────────────────────
phantom_auth() {
    if [ $# -eq 0 ]; then
        phantom_auth_status
        return
    fi

    local subcmd="$1"
    shift

    case "$subcmd" in
        sync)
            phantom_auth_sync "$@"
            ;;
        status)
            phantom_auth_status "$@"
            ;;
        --help|-h)
            cat <<EOF
${BOLD}phantom auth${NC} - Credential management

${BOLD}USAGE${NC}
    phantom auth                          Show credential status
    phantom auth sync [--key K]           Sync credentials from VPS
    phantom auth status                   Check credential and connection status

${BOLD}OPTIONS${NC}
    ${GREEN}--key API_KEY${NC}       API key authentication (recommended)
    ${YELLOW}--password PASS${NC}     SSH password authentication (legacy)

${BOLD}EXAMPLES${NC}
    phantom auth sync --key sk-phantom-xxx
    phantom auth status

EOF
            ;;
        *)
            log_error "Unknown auth command: $subcmd"
            log_info "Usage: phantom auth [sync|status] (see: phantom auth --help)"
            return 1
            ;;
    esac
}

# ── Init command (interactive wizard, backward compatible) ─────────
phantom_init() {
    echo -e "${BOLD}Phantom CLI Setup Wizard${NC}"
    echo "────────────────────────────────────────"
    echo ""

    # Ensure config dir exists
    phantom_config_init

    # VPS settings
    local current_host
    current_host=$(phantom_config_get "SERVER_HOST" 2>/dev/null || echo "")
    read -rp "VPS IP/hostname [${current_host:-none}]: " input_host
    local host="${input_host:-$current_host}"
    if [ -z "$host" ]; then
        log_error "VPS host is required"
        return 1
    fi

    local current_port
    current_port=$(phantom_config_get "SERVER_PORT" 2>/dev/null || echo "22")
    read -rp "SSH port [${current_port}]: " input_port
    local port="${input_port:-$current_port}"

    local current_http_proxy_port
    current_http_proxy_port=$(phantom_config_get "HTTP_PROXY_PORT" 2>/dev/null || echo "8080")
    read -rp "HTTP proxy port [${current_http_proxy_port}]: " input_http_proxy_port
    local http_proxy_port="${input_http_proxy_port:-$current_http_proxy_port}"

    # SSH key (for tunnel mode)
    local current_ssh_key
    current_ssh_key=$(phantom_config_get "SSH_KEY" 2>/dev/null || echo "$HOME/.ssh/id_rsa")
    read -rp "SSH key path [${current_ssh_key}]: " input_ssh_key
    local ssh_key="${input_ssh_key:-$current_ssh_key}"

    # Connection mode
    local current_mode
    current_mode=$(phantom_config_get "CONNECTION_MODE" 2>/dev/null || echo "direct")
    echo ""
    echo "Connection mode:"
    echo "  direct  - Connect to VPS HTTP proxy directly (simpler, recommended)"
    echo "  tunnel  - SSH tunnel to VPS (more secure, encrypts traffic)"
    read -rp "Connection mode (direct/tunnel) [${current_mode}]: " input_mode
    local connection_mode="${input_mode:-$current_mode}"

    # Save config
    phantom_config_set "SERVER_HOST" "$host"
    phantom_config_set "SERVER_PORT" "$port"
    phantom_config_set "HTTP_PROXY_PORT" "$http_proxy_port"
    phantom_config_set "SSH_KEY" "$ssh_key"
    phantom_config_set "CONNECTION_MODE" "$connection_mode"

    echo ""
    log_success "Configuration saved to $PHANTOM_CONFIG"

    # Setup sandbox
    phantom_sandbox_setup
    log_success "Shadow sandbox created at $SHADOW_HOME"

    echo ""
    log_info "Run ${GREEN}phantom${NC} to start Claude through the proxy"
}

# ── Status command ──────────────────────────────────────────────────
phantom_status() {
    echo -e "${BOLD}Phantom Status${NC}"
    echo "────────────────────────────────────────"

    # Config check
    if [ ! -f "$PHANTOM_CONFIG" ]; then
        log_warn "Not configured. Run: phantom setup <VPS_IP>"
        return 1
    fi

    local host port http_proxy_port connection_mode
    host=$(phantom_config_get "SERVER_HOST" 2>/dev/null || echo "not set")
    port=$(phantom_config_get "SERVER_PORT" 2>/dev/null || echo "not set")
    http_proxy_port=$(phantom_config_get "HTTP_PROXY_PORT" 2>/dev/null || echo "8080")
    connection_mode=$(phantom_config_get "CONNECTION_MODE" 2>/dev/null || echo "direct")

    echo -e "  Server:     ${CYAN}${host}${NC}"
    echo -e "  HTTP Proxy: ${CYAN}${host}:${http_proxy_port}${NC}"
    echo -e "  Mode:       ${CYAN}${connection_mode}${NC}"
    echo -e "  Sandbox:    ${CYAN}${SHADOW_HOME}${NC}"
    echo ""

    # Proxy reachability
    if [ "$connection_mode" = "direct" ]; then
        if nc -z -w 3 "$host" "$http_proxy_port" 2>/dev/null; then
            echo -e "  Proxy:      ${GREEN}connected${NC}"
        else
            echo -e "  Proxy:      ${RED}unreachable${NC}"
        fi
    else
        phantom_tunnel_status
    fi
}

# ── Config command ─────────────────────────────────────────────────
phantom_config_cmd() {
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
${BOLD}phantom config${NC} - View or modify configuration

${BOLD}USAGE${NC}
    phantom config                Show all configuration
    phantom config <KEY>          Get a specific value
    phantom config <KEY> <VALUE>  Set a specific value

${BOLD}KEYS${NC}
    SERVER_HOST       VPS IP address
    HTTP_PROXY_PORT   Proxy port (default: 8080)
    CONNECTION_MODE   direct or tunnel
    API_KEY           API key for authentication
    SSH_KEY           SSH key path (tunnel mode)
    AUTO_CONNECT      Auto-connect on launch (true/false)

${BOLD}EXAMPLES${NC}
    phantom config                          # Show all
    phantom config SERVER_HOST              # Get server IP
    phantom config HTTP_PROXY_PORT 9090     # Change proxy port
    phantom config API_KEY sk-phantom-xxx   # Set API key

EOF
        return 0
    fi

    if [ $# -eq 0 ]; then
        # Show all config
        if [ ! -f "$PHANTOM_CONFIG" ]; then
            log_warn "Not configured. Run: phantom setup <VPS_IP>"
            return 1
        fi
        echo -e "${BOLD}Phantom Configuration${NC} ($PHANTOM_CONFIG)"
        echo "────────────────────────────────────────"
        # Show non-comment, non-empty lines with masking for sensitive values
        while IFS='=' read -r key value; do
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            if [[ "$key" == "API_KEY" ]] && [[ -n "$value" ]]; then
                echo -e "  ${CYAN}${key}${NC} = ${value:0:12}...${value: -4}"
            else
                echo -e "  ${CYAN}${key}${NC} = ${value:-${YELLOW}(not set)${NC}}"
            fi
        done < "$PHANTOM_CONFIG"
        return 0
    fi

    if [ $# -eq 1 ]; then
        # Get a specific key
        local val
        val=$(phantom_config_get "$1" 2>/dev/null) || { log_error "$1 is not set"; return 1; }
        echo "$val"
        return 0
    fi

    # Set a key
    phantom_config_set "$1" "$2"
    log_success "$1 = $2"
}

# ── Main router ─────────────────────────────────────────────────────
main() {
    # No arguments → default to launching claude
    if [ $# -eq 0 ]; then
        phantom_hijack_exec claude
        exit 0
    fi

    local cmd="$1"

    case "$cmd" in
        # Known subcommands → route to handler
        setup)
            shift
            phantom_setup "$@"
            ;;
        auth)
            shift
            phantom_auth "$@"
            ;;
        config)
            shift
            phantom_config_cmd "$@"
            ;;
        init)
            shift
            phantom_init "$@"
            ;;
        connect)
            shift
            phantom_tunnel_connect "$@"
            ;;
        disconnect)
            shift
            phantom_tunnel_disconnect "$@"
            ;;
        status)
            shift
            phantom_status "$@"
            ;;
        doctor)
            shift
            phantom_doctor_run "$@"
            ;;
        help|--help|-h)
            phantom_usage
            ;;
        version|--version|-v)
            echo "phantom v${PHANTOM_VERSION}"
            ;;
        -*)
            # Arguments starting with - → pass through to claude
            phantom_hijack_exec claude "$@"
            ;;
        *)
            # Everything else → hijack the command
            shift
            phantom_hijack_exec "$cmd" "$@"
            ;;
    esac
}

main "$@"
